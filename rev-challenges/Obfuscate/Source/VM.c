#include "VM.h"

BYTE Flag[30] = { 0x45, 0x6d, 0x6b, 0x77, 0x61, 0x7e, 0x31, 0x75, 0x7d, 0x3e, 0x62, 0x54, 0x60, 0x3c, 0x3d, 0x3a, 0x4f, 0x20, 0x7c, 0x4c, 0x23, 0x7d, 0x25, 0x48, 0x7b, 0x29, 0x7e, 0x28, 0x61, 0x1d };
BYTE Buffer[30] = { 0 };
HANDLER_TYPE Handlers[] = {
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	VMZero,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	VMPrint,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	VMDecrypt,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	VMCopy,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
	0x0,
};

VOID VMDispatcher(PBYTE Instructions, SIZE_T InstructionsLength) {
	for (int i = 0; i < InstructionsLength; i++) {
		Handlers[Instructions[i]]();
	}
}

VOID VMPrint() {
	printf("Hello World!\n");
}

VOID VMCopy() {
	memcpy(Buffer, Flag, sizeof(Flag));
}

VOID VMZero() {
	memset(Buffer, 0, sizeof(Buffer));
	memset(Flag, 0, sizeof(Flag));
}

VOID VMDecrypt() {
	for (int i = 0; i < sizeof(Buffer); i++) {
		Buffer[i] = Buffer[i] ^ i;
	}
}